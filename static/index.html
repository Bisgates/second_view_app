<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SecondView – 1s Stock Data</title>
<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#0b0f14;--bg2:#0f141b;--bg3:#151b24;--bg4:#1e2531;--card:#171d27;
    --text:#e6e8ee;--text2:#a5adbb;--text3:#6b7382;
    --green:#4ade80;--red:#f87171;--amber:#fbbf24;--blue:#60a5fa;
    --orange:#f59e0b;--purple:#a78bfa;--cyan:#22d3ee;
    --border:#1f2633;--accent:#60a5fa;
    --radius-lg:14px;--radius-md:10px;--radius-sm:8px;
  }
  html,body{height:100%;background:var(--bg);color:var(--text);font-family:'SF Pro Text',-apple-system,BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Arial,sans-serif;font-size:13px;overflow:hidden}
  .hidden{display:none !important}

  /* Header */
  .header{display:flex;align-items:center;gap:16px;padding:10px 16px;background:linear-gradient(180deg,#111723 0%,#0f141b 100%);border-bottom:1px solid var(--border);height:52px}
  .logo{font-size:16px;font-weight:700;color:var(--text);white-space:nowrap;letter-spacing:.2px}
  .logo span{color:var(--text3);font-weight:500;font-size:12px;margin-left:8px}
  .clock{margin-left:auto;color:var(--text3);font-size:12px}

  /* App Body */
  .app-body{display:flex;height:calc(100vh - 52px);overflow:hidden}

  /* Sidebar */
  .sidebar{width:250px;flex-shrink:0;background:linear-gradient(180deg,#0f141b 0%,#0b0f14 100%);border-right:1px solid var(--border);overflow-y:auto;scrollbar-width:thin;padding:12px 10px}
  .sidebar::-webkit-scrollbar{width:6px}
  .sidebar::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:6px}

  .date-group{padding:4px 0 10px 0}
  .date-header{display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:var(--radius-md);cursor:pointer;color:var(--text2);font-size:12px;font-weight:600;transition:all .15s;user-select:none;background:var(--bg3)}
  .date-header:hover{background:var(--bg4);color:var(--text)}
  .date-header.active{color:#dbeafe;box-shadow:inset 0 0 0 1px rgba(96,165,250,.35)}
  .date-header .chevron{font-size:10px;transition:transform .15s;width:12px;text-align:center;flex-shrink:0;color:var(--text3)}
  .date-header .chevron.expanded{transform:rotate(90deg)}
  .date-header .date-label{flex:1}

  .sym-list{overflow:hidden;padding:8px 4px 0 4px}
  .sym-list.collapsed{display:none}

  .sym-card{display:grid;grid-template-columns:1fr auto;grid-template-rows:auto auto;gap:4px 10px;padding:9px 10px;border-radius:12px;cursor:pointer;transition:all .15s;background:linear-gradient(180deg,#1a202b 0%,#141a24 100%);border:1px solid transparent}
  .sym-card + .sym-card{margin-top:8px}
  .sym-card:hover{border-color:rgba(96,165,250,.35);background:#19212d}
  .sym-card.active{border-color:rgba(96,165,250,.7);background:#1b2332;box-shadow:0 8px 20px rgba(0,0,0,.35)}
  .sym-card .sym-name{font-weight:700;font-size:14px;letter-spacing:.2px;color:var(--text);grid-column:1/2}
  .sym-card .sym-price{font-size:14px;font-weight:600;color:var(--text);grid-column:2/3;grid-row:1/2;justify-self:end}
  .sym-card .sym-change{font-size:11px;font-weight:600;padding:3px 7px;border-radius:7px;grid-column:2/3;grid-row:2/3;justify-self:end}
  .sym-card .sym-change.up{color:#0b1f12;background:rgba(74,222,128,.9)}
  .sym-card .sym-change.down{color:#2b0d0d;background:rgba(248,113,113,.9)}

  /* Main Layout */
  .main{display:flex;flex:1;min-width:0;overflow:hidden}
  .chart-section{flex:1;display:flex;flex-direction:column;min-width:0}
  .stats-panel{width:220px;background:var(--bg2);border-left:1px solid var(--border);overflow-y:auto;padding:12px;flex-shrink:0}

  /* Chart Toolbar */
  .toolbar{display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--bg);border-bottom:1px solid var(--border);flex-wrap:wrap}
  .toolbar-sym{font-size:18px;font-weight:700;margin-right:4px;letter-spacing:.2px}
  .toolbar-price{font-size:16px;margin-right:4px;color:var(--text)}
  .toolbar-change{font-size:14px;margin-right:12px}
  .toolbar-change.up{color:var(--green)}
  .toolbar-change.down{color:var(--red)}
  .btn-group{display:flex;gap:2px;background:var(--bg3);border-radius:var(--radius-sm);padding:2px}
  .btn{padding:5px 12px;background:transparent;color:var(--text2);cursor:pointer;font-size:11px;border:none;font-family:inherit;transition:all .15s;border-radius:var(--radius-sm)}
  .btn:hover{background:var(--bg4);color:var(--text)}
  .btn.active{background:rgba(96,165,250,.25);color:#dbeafe}
  .toggle-btn{padding:5px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg3);color:var(--text2);cursor:pointer;font-size:11px;font-family:inherit;transition:all .15s}
  .toggle-btn:hover{border-color:rgba(96,165,250,.5);color:var(--text)}
  .toggle-btn.active{background:rgba(96,165,250,.2);border-color:rgba(96,165,250,.7);color:#dbeafe}
  .toolbar-sep{width:1px;height:20px;background:var(--border);margin:0 4px}

  /* Chart Container */
  .chart-wrap{flex:1;position:relative;min-height:0}
  #chart{width:100%;height:100%}

  /* MA Legend overlay (top of chart) */
  .ma-legend{position:absolute;top:10px;left:12px;z-index:10;font-size:11px;color:var(--text3);pointer-events:none;line-height:1.5;white-space:nowrap}

  /* Volume Legend overlay (above volume area) */
  .vol-legend{position:absolute;bottom:60px;left:12px;z-index:10;font-size:11px;color:var(--text3);pointer-events:none}

  /* Chart OHLC legend (below MA legend) */
  .chart-legend{position:absolute;top:30px;left:12px;z-index:10;font-size:11px;color:var(--text2);pointer-events:none;line-height:1.6}
  .chart-legend .legend-time{color:var(--cyan)}
  .chart-legend .legend-value{color:var(--text)}
  .chart-legend .legend-vol{color:var(--green)}

  /* Stats Panel */
  .stat-section{margin-bottom:16px}
  .stat-title{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border)}
  .stat-row{display:flex;justify-content:space-between;padding:2px 0;font-size:12px}
  .stat-label{color:var(--text3)}
  .stat-value{color:var(--text);font-weight:500}
  .stat-value.up{color:var(--green)}
  .stat-value.down{color:var(--red)}


  /* Loading */
  .loading-overlay{position:absolute;inset:0;background:rgba(10,14,23,.85);display:flex;align-items:center;justify-content:center;z-index:100;font-size:14px;color:var(--text2)}
  .loading-overlay.hidden{display:none}
  .spinner{width:24px;height:24px;border:2px solid var(--bg4);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;margin-right:10px}
  @keyframes spin{to{transform:rotate(360deg)}}

</style>
</head>
<body>

<div class="header">
  <div class="logo">SecondView<span>1s Data</span></div>
  <div class="btn-group" id="tzGroup">
    <button class="btn" data-val="America/New_York">ET</button>
    <button class="btn active" data-val="Asia/Shanghai">BJ</button>
  </div>
  <div class="clock" id="clock"></div>
</div>

<div class="app-body">
<div class="sidebar" id="sidebar">
  <div id="sidebarContent"></div>
</div>

<div class="main">
  <div class="chart-section">
    <div class="toolbar">
      <span class="toolbar-sym" id="tbSymbol">-</span>
      <span class="toolbar-price" id="tbPrice">-</span>
      <span class="toolbar-change" id="tbChange">-</span>
      <div class="toolbar-sep"></div>
      <div class="btn-group" id="chartTypeGroup">
        <button class="btn active" data-val="line">Line</button>
        <button class="btn" data-val="candle">Candle</button>
      </div>
      <div class="btn-group" id="resGroup">
        <button class="btn active" data-val="1">1s</button>
        <button class="btn" data-val="5">5s</button>
        <button class="btn" data-val="10">10s</button>
        <button class="btn" data-val="60">1m</button>
      </div>
      <div class="btn-group" id="sessionGroup">
        <button class="btn active" data-val="all">All</button>
        <button class="btn" data-val="premarket">Pre</button>
        <button class="btn" data-val="market">Mkt</button>
        <button class="btn" data-val="afterhours">Ext</button>
      </div>
      <div class="toolbar-sep"></div>
      <button class="toggle-btn active" id="toggleMA">MA</button>
      <button class="toggle-btn active" id="toggleFilter">Hampel</button>
    </div>
    <div class="chart-wrap">
      <div class="ma-legend" id="maLegend"></div>
      <div class="chart-legend" id="chartLegend"></div>
      <div class="vol-legend" id="volLegend"></div>
      <div id="chart"></div>
      <div class="loading-overlay hidden" id="loading">
        <div class="spinner"></div>Loading…
      </div>
    </div>
  </div>
  <div class="stats-panel hidden" id="statsPanel"></div>
</div>
</div>

<script>
(function(){
  // ---- MA Config ----
  const MA_PERIODS = [5, 100, 200];
  const MA_COLORS = {
    '5':   '#22c55e',  // green
    '100': '#f97316',  // orange
    '200': '#a855f7',  // purple
  };

  // ---- State ----
  let state = {
    dates: {},
    currentDate: null,
    currentSymbol: null,
    chartType: 'line',
    resolution: 1,
    session: 'all',
    showMA: true,
    useClean: false,
    spikeFilter: true,
    data: null,
    tz: 'Asia/Shanghai',
  };

  // ---- Chart globals ----
  let chart = null;
  let mainSeries = null;
  let volumeSeries = null;
  let maSeries = {};      // keyed by period string
  let volMaSeries = null;  // Volume MA line

  // ---- DOM refs ----
  const $ = id => document.getElementById(id);
  const sidebarContent = $('sidebarContent');
  const chartEl = $('chart');
  const loading = $('loading');
  const legend = $('chartLegend');
  const maLegend = $('maLegend');
  const volLegend = $('volLegend');

  // ---- API ----
  async function fetchJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return res.json();
  }

  // ---- Init ----
  async function init() {
    updateClock();
    setInterval(updateClock, 1000);
    try {
      const resp = await fetchJSON('/api/dates');
      state.dates = resp.dates;
      const dateKeys = Object.keys(state.dates).sort().reverse();
      if (dateKeys.length === 0) return;
      renderSidebar(dateKeys);
      selectDate(dateKeys[0]);
    } catch(e) {
      console.error('init error', e);
    }
  }

  function tzLabel() { return state.tz === 'Asia/Shanghai' ? 'BJ' : 'ET'; }

  function updateClock() {
    const now = new Date();
    const t = now.toLocaleString('en-US', {timeZone: state.tz, hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false});
    $('clock').textContent = `${tzLabel()} ${t}`;
  }

  // ---- Sidebar ----
  function renderSidebar(dates) {
    sidebarContent.innerHTML = '';
    dates.forEach(d => {
      const group = document.createElement('div');
      group.className = 'date-group';
      group.dataset.date = d;

      const header = document.createElement('div');
      header.className = 'date-header';
      header.innerHTML = `<span class="chevron">▶</span><span class="date-label">${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)}</span>`;
      header.onclick = () => handleDateClick(d);
      group.appendChild(header);

      const symList = document.createElement('div');
      symList.className = 'sym-list collapsed';
      group.appendChild(symList);

      sidebarContent.appendChild(group);
    });
  }

  function handleDateClick(date) {
    if (state.currentDate === date) {
      // Toggle expand/collapse for the already-selected date
      const group = sidebarContent.querySelector(`.date-group[data-date="${date}"]`);
      if (group) {
        const symList = group.querySelector('.sym-list');
        const chevron = group.querySelector('.chevron');
        symList.classList.toggle('collapsed');
        chevron.classList.toggle('expanded');
      }
    } else {
      selectDate(date);
    }
  }

  function selectDate(date) {
    state.currentDate = date;

    // Update all date headers: highlight active, collapse others
    sidebarContent.querySelectorAll('.date-group').forEach(g => {
      const d = g.dataset.date;
      const header = g.querySelector('.date-header');
      const symList = g.querySelector('.sym-list');
      const chevron = g.querySelector('.chevron');
      if (d === date) {
        header.classList.add('active');
        symList.classList.remove('collapsed');
        chevron.classList.add('expanded');
      } else {
        header.classList.remove('active');
        symList.classList.add('collapsed');
        chevron.classList.remove('expanded');
      }
    });

    const symbols = state.dates[date] || [];
    renderSymbolList(date, symbols);
    if (symbols.length > 0) {
      selectSymbol(symbols[0].symbol);
    }
  }

  function renderSymbolList(date, symbols) {
    const group = sidebarContent.querySelector(`.date-group[data-date="${date}"]`);
    if (!group) return;
    const symList = group.querySelector('.sym-list');
    symList.innerHTML = '';
    symbols.forEach(s => {
      const card = document.createElement('div');
      card.className = 'sym-card';
      card.dataset.symbol = s.symbol;
      const up = s.change_pct >= 0;
      card.innerHTML = `
        <div class="sym-name">${s.symbol}</div>
        <div class="sym-price">$${s.close.toFixed(2)}</div>
        <div class="sym-change ${up?'up':'down'}">${up?'+':''}${s.change_pct.toFixed(2)}%</div>
      `;
      card.onclick = () => selectSymbol(s.symbol);
      symList.appendChild(card);
    });
  }

  function selectSymbol(symbol) {
    state.currentSymbol = symbol;
    document.querySelectorAll('.sym-card').forEach(c => c.classList.toggle('active', c.dataset.symbol === symbol));
    loadChart();
  }

  // ---- Button groups ----
  function setupBtnGroup(groupId, onChange) {
    const group = $(groupId);
    group.querySelectorAll('.btn').forEach(btn => {
      btn.addEventListener('click', () => {
        group.querySelectorAll('.btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        onChange(btn.dataset.val);
      });
    });
  }

  function setGroupValue(groupId, val) {
    const group = $(groupId);
    group.querySelectorAll('.btn').forEach(b => {
      b.classList.toggle('active', b.dataset.val === val);
    });
  }

  setupBtnGroup('chartTypeGroup', v => { state.chartType = v; loadChart(); });
  setupBtnGroup('resGroup', v => { state.resolution = parseInt(v); loadChart(); });
  setupBtnGroup('sessionGroup', v => { state.session = v; loadChart(); });
  setupBtnGroup('tzGroup', v => { state.tz = v; updateClock(); });

  $('toggleMA').addEventListener('click', function() {
    state.showMA = !state.showMA;
    this.classList.toggle('active', state.showMA);
    updateIndicatorVisibility();
  });
  $('toggleFilter').addEventListener('click', function() {
    state.spikeFilter = !state.spikeFilter;
    this.classList.toggle('active', state.spikeFilter);
    loadChart();
  });

  // ---- Chart ----
  function createChart() {
    if (chart) { chart.remove(); chart = null; }
    maSeries = {};
    volMaSeries = null;

    chart = LightweightCharts.createChart(chartEl, {
      layout: {
        background: { type: 'solid', color: '#0b0f14' },
        textColor: '#9aa3b2',
        fontSize: 11,
        fontFamily: "'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Inter, Roboto, Arial, sans-serif",
      },
      grid: {
        vertLines: { color: 'rgba(34,42,56,0.55)' },
        horzLines: { color: 'rgba(34,42,56,0.55)' },
      },
      crosshair: {
        mode: LightweightCharts.CrosshairMode.Normal,
        vertLine: { color: 'rgba(96,165,250,0.35)', width: 1, style: 0 },
        horzLine: { color: 'rgba(96,165,250,0.35)', width: 1, style: 0 },
      },
      rightPriceScale: {
        borderColor: '#1f2633',
        scaleMargins: { top: 0.05, bottom: 0.2 },
      },
      leftPriceScale: {
        visible: true,
        borderColor: '#1f2633',
      },
      timeScale: {
        borderColor: '#1f2633',
        timeVisible: true,
        secondsVisible: true,
        rightOffset: 5,
        barSpacing: 6,
        minBarSpacing: 0.5,
      },
      handleScale: { axisPressedMouseMove: { time: false, price: true } },
      handleScroll: { vertTouchDrag: false },
    });

    // Volume sub-chart using histogram on price scale 'vol'
    volumeSeries = chart.addHistogramSeries({
      priceFormat: { type: 'volume' },
      priceScaleId: 'vol',
    });
    chart.priceScale('vol').applyOptions({
      scaleMargins: { top: 0.85, bottom: 0 },
      drawTicks: false,
      borderVisible: false,
    });

    // Volume MA line (on vol scale)
    volMaSeries = chart.addLineSeries({
      color: '#f87171',
      lineWidth: 1,
      priceScaleId: 'vol',
      priceLineVisible: false,
      lastValueVisible: false,
      crosshairMarkerVisible: false,
    });

    // MA series (all periods)
    MA_PERIODS.forEach(p => {
      const key = String(p);
      maSeries[key] = chart.addLineSeries({
        color: MA_COLORS[key] || '#94a3b8',
        lineWidth: 1,
        priceLineVisible: false,
        lastValueVisible: false,
        crosshairMarkerVisible: false,
      });
    });

    // Crosshair legend
    chart.subscribeCrosshairMove(param => {
      if (!param || !param.time || !state.data) {
        updateLegend(null);
        updateMALegend(null);
        updateVolLegend(null);
        return;
      }
      const d = { time: param.time };

      // Main series data
      if (mainSeries) {
        const v = param.seriesData.get(mainSeries);
        if (v) d.main = v;
      }

      // Volume
      if (volumeSeries) {
        const v = param.seriesData.get(volumeSeries);
        if (v) d.vol = v.value;
      }

      // MA values
      d.mas = {};
      if (state.showMA) {
        MA_PERIODS.forEach(p => {
          const key = String(p);
          if (maSeries[key]) {
            const v = param.seriesData.get(maSeries[key]);
            if (v) d.mas[key] = v.value;
          }
        });
      }

      // Volume MA
      if (volMaSeries) {
        const v = param.seriesData.get(volMaSeries);
        if (v) d.volMa = v.value;
      }

      updateLegend(d);
      updateMALegend(d);
      updateVolLegend(d);
    });

    new ResizeObserver(() => {
      chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
    }).observe(chartEl);
  }

  function formatTime(epoch) {
    const dt = new Date(epoch * 1000);
    return dt.toLocaleString('en-US', {timeZone: state.tz, month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false});
  }

  function formatVol(n) {
    if (n >= 1e6) return (n/1e6).toFixed(2)+'M';
    if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
    return Math.round(n).toLocaleString();
  }

  function updateMALegend(d) {
    if (!state.showMA) {
      maLegend.innerHTML = '';
      return;
    }
    let html = '<span style="color:#94a3b8">MA</span> &nbsp;';
    MA_PERIODS.forEach(p => {
      const key = String(p);
      const color = MA_COLORS[key] || '#94a3b8';
      const val = (d && d.mas && d.mas[key] !== undefined) ? d.mas[key].toFixed(3) : '';
      html += `<span style="color:${color}">MA${p}:${val}</span> &nbsp;`;
    });
    maLegend.innerHTML = html;
  }

  function updateVolLegend(d) {
    let html = '<span style="color:#94a3b8">成交量</span> &nbsp;';
    if (d && d.vol !== undefined) {
      html += `<span style="color:#e2e8f0">VOL: ${formatVol(d.vol)}</span>`;
    }
    if (d && d.volMa !== undefined) {
      html += ` &nbsp;<span style="color:#ef4444">MA20: ${formatVol(d.volMa)}</span>`;
    }
    volLegend.innerHTML = html;
  }

  function updateLegend(d) {
    if (!d || !d.main) {
      legend.innerHTML = '';
      return;
    }
    const m = d.main;
    let html = '';
    // Time
    if (d.time) html += `<span class="legend-time">${formatTime(d.time)}</span> &nbsp; `;
    // OHLC or line price
    if (m.open !== undefined) {
      html += `O <span class="legend-value">${m.open.toFixed(2)}</span> `;
      html += `H <span class="legend-value">${m.high.toFixed(2)}</span> `;
      html += `L <span class="legend-value">${m.low.toFixed(2)}</span> `;
      html += `C <span class="legend-value">${m.close.toFixed(2)}</span>`;
    } else if (m.value !== undefined) {
      html += `Price <span class="legend-value">${m.value.toFixed(2)}</span>`;
    }
    legend.innerHTML = html;
  }

  // ---- Load data & render ----
  async function loadChart() {
    if (!state.currentDate || !state.currentSymbol) return;
    loading.classList.remove('hidden');

    // Save current view center time before re-render
    let savedCenter = null;
    let savedHalfSpan = null;
    if (chart) {
      const range = chart.timeScale().getVisibleRange();
      if (range) {
        savedCenter = (range.from + range.to) / 2;
        savedHalfSpan = (range.to - range.from) / 2;
      }
    }

    const params = new URLSearchParams({
      session: state.session,
      resolution: state.resolution,
      use_clean: state.useClean,
    });
    if (state.spikeFilter) {
      params.set('spike_filter', 'hampel');
      params.set('spike_window', 3);
    }

    try {
      const data = await fetchJSON(`/api/price/${state.currentDate}/${state.currentSymbol}?${params}`);
      state.data = data;
      renderChart(data, savedCenter, savedHalfSpan);
      updateToolbar(data);
      updateStats(data);
    } catch(e) {
      console.error('load error', e);
    } finally {
      loading.classList.add('hidden');
    }
  }

  function applyBarSpacing() {
    if (!chart) return;
    let spacing = 6;
    let minSpacing = 1.5;
    if (state.resolution <= 1) {
      spacing = 3;
      minSpacing = 1.5;
    } else if (state.resolution <= 5) {
      spacing = 4;
      minSpacing = 1.7;
    } else if (state.resolution <= 10) {
      spacing = 6;
      minSpacing = 2.0;
    } else {
      spacing = 8;
      minSpacing = 2.2;
    }
    chart.timeScale().applyOptions({
      barSpacing: spacing,
      minBarSpacing: minSpacing,
    });
  }

  function renderChart(data, savedCenter, savedHalfSpan) {
    createChart();
    applyBarSpacing();

    // Main series
    if (state.chartType === 'candle') {
      mainSeries = chart.addCandlestickSeries({
        upColor: '#22c55e',
        downColor: '#ef4444',
        borderUpColor: '#22c55e',
        borderDownColor: '#ef4444',
        wickUpColor: '#22c55e',
        wickDownColor: '#ef4444',
        borderVisible: true,
        wickVisible: true,
      });
      mainSeries.setData(data.candles);
    } else {
      mainSeries = chart.addLineSeries({
        color: '#3b82f6',
        lineWidth: 1.5,
        priceLineVisible: true,
        lastValueVisible: true,
      });
      const lineData = data.candles.map(c => ({ time: c.time, value: c.close }));
      mainSeries.setData(lineData);
    }

    // Volume
    volumeSeries.setData(data.volume);

    // Volume MA
    if (data.volume_ma && data.volume_ma.length > 0) {
      volMaSeries.setData(data.volume_ma);
    }

    // MAs (from "mas" dict)
    MA_PERIODS.forEach(p => {
      const key = String(p);
      const maData = (data.mas && data.mas[key]) ? data.mas[key] : [];
      maSeries[key].setData(maData);
      maSeries[key].applyOptions({ visible: state.showMA });
    });

    // Markers: market open + high/low annotations
    const markers = [];

    // Market open marker
    if (data.market_open_time && data.candles.length > 0) {
      const markerCandle = data.candles.find(c => c.time >= data.market_open_time);
      if (markerCandle) {
        markers.push({
          time: markerCandle.time,
          position: 'belowBar',
          color: '#f59e0b',
          shape: 'arrowUp',
          text: '9:30',
        });
      }
    }

    // High point marker
    if (data.stats && data.stats.high_time) {
      markers.push({
        time: data.stats.high_time,
        position: 'aboveBar',
        color: '#22c55e',
        shape: 'circle',
        text: data.stats.high.toFixed(3),
      });
    }

    // Low point marker
    if (data.stats && data.stats.low_time) {
      markers.push({
        time: data.stats.low_time,
        position: 'belowBar',
        color: '#ef4444',
        shape: 'circle',
        text: data.stats.low.toFixed(3),
      });
    }

    // Sort markers by time (required by lightweight-charts)
    markers.sort((a, b) => a.time - b.time);
    if (markers.length > 0) {
      mainSeries.setMarkers(markers);
    }

    // Initialize MA legend with last values
    updateMALegend({ mas: getLastMAValues(data) });
    updateVolLegend({});

    if (savedCenter != null && savedHalfSpan != null) {
      chart.timeScale().setVisibleRange({
        from: savedCenter - savedHalfSpan,
        to: savedCenter + savedHalfSpan,
      });
    } else {
      chart.timeScale().fitContent();
    }
    applyBarSpacing();
  }

  function getLastMAValues(data) {
    const vals = {};
    if (!data.mas) return vals;
    MA_PERIODS.forEach(p => {
      const key = String(p);
      const arr = data.mas[key];
      if (arr && arr.length > 0) {
        vals[key] = arr[arr.length - 1].value;
      }
    });
    return vals;
  }

  function updateIndicatorVisibility() {
    MA_PERIODS.forEach(p => {
      const key = String(p);
      if (maSeries[key]) maSeries[key].applyOptions({ visible: state.showMA });
    });
    // Update MA legend visibility
    if (!state.showMA) {
      maLegend.innerHTML = '';
    } else if (state.data) {
      updateMALegend({ mas: getLastMAValues(state.data) });
    }
  }

  function updateToolbar(data) {
    const s = data.stats;
    $('tbSymbol').textContent = data.symbol;
    $('tbPrice').textContent = `$${s.close.toFixed(2)}`;
    const changeEl = $('tbChange');
    const up = s.change >= 0;
    changeEl.textContent = `${up?'+':''}${s.change.toFixed(2)} (${up?'+':''}${s.change_pct.toFixed(2)}%)`;
    changeEl.className = 'toolbar-change ' + (up ? 'up' : 'down');
  }

  function updateStats(data) {
    const s = data.stats;
    const up = s.change >= 0;

    $('statPrice').innerHTML = `
      <div class="stat-row"><span class="stat-label">Open</span><span class="stat-value">${s.open.toFixed(4)}</span></div>
      <div class="stat-row"><span class="stat-label">High</span><span class="stat-value">${s.high.toFixed(4)}</span></div>
      <div class="stat-row"><span class="stat-label">Low</span><span class="stat-value">${s.low.toFixed(4)}</span></div>
      <div class="stat-row"><span class="stat-label">Close</span><span class="stat-value">${s.close.toFixed(4)}</span></div>
      <div class="stat-row"><span class="stat-label">Change</span><span class="stat-value ${up?'up':'down'}">${up?'+':''}${s.change.toFixed(4)}</span></div>
      <div class="stat-row"><span class="stat-label">Change%</span><span class="stat-value ${up?'up':'down'}">${up?'+':''}${s.change_pct.toFixed(2)}%</span></div>
    `;

    $('statVolume').innerHTML = `
      <div class="stat-row"><span class="stat-label">Total</span><span class="stat-value">${formatNumber(s.volume)}</span></div>
    `;

    $('statSession').innerHTML = `
      <div class="stat-row"><span class="stat-label">Filter</span><span class="stat-value">${data.session}</span></div>
      <div class="stat-row"><span class="stat-label">Resolution</span><span class="stat-value">${data.resolution}s</span></div>
    `;

    const firstT = new Date(s.first_time * 1000).toLocaleString('en-US', {timeZone: state.tz, hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false});
    const lastT = new Date(s.last_time * 1000).toLocaleString('en-US', {timeZone: state.tz, hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false});
    $('statData').innerHTML = `
      <div class="stat-row"><span class="stat-label">Points</span><span class="stat-value">${formatNumber(s.data_points)}</span></div>
      <div class="stat-row"><span class="stat-label">First</span><span class="stat-value">${firstT}</span></div>
      <div class="stat-row"><span class="stat-label">Last</span><span class="stat-value">${lastT}</span></div>
    `;
  }

  function formatNumber(n) {
    if (n >= 1e9) return (n/1e9).toFixed(2)+'B';
    if (n >= 1e6) return (n/1e6).toFixed(2)+'M';
    if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
    return n.toLocaleString();
  }

  // ---- Start ----
  init();
})();
</script>
</body>
</html>
