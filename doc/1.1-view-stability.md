# 1.1 - 视图稳定逻辑

目标：切换分辨率、盘段或过滤器时尽量保持“视图中心时间”不跳变，避免用户视线丢失。

## 1. 保存视图中心

触发重载前，`static/js/data.js` 的 `getViewState()` 会尝试取出当前视图的中心时间：

1. **优先用 logical 坐标**
   - `coordinateToLogical(中心像素)` → 得到中心逻辑索引
   - 根据当前数据的 `resolution` 与第一根 K 线时间反推出 `centerTime`
   - 这是为了解决不同分辨率下的时间定位偏差
2. **fallback：直接取中心像素的 time**
   - `coordinateToTime(中心像素)`
3. **最后 fallback：可见区间中心**
   - `getVisibleRange()` 求 (from + to) / 2

得到的 `centerTime` 会被传入 `renderChart()`。

## 2. 在新图表上恢复中心

`static/js/chart.js` 在完成绘制后会执行：

1. 将 `centerTime` 转为逻辑坐标：
   - `centerLogical = (centerTime - firstTime) / resolution`
2. 读取当前图表的 `visibleLogicalRange` 作为默认视窗宽度
3. 以 `centerLogical` 为中心，设置新的 `visibleLogicalRange`
4. 如果无法计算，则 `fitContent()` 全量展示

## 3. 设计取舍

- 只保存“中心时间”，不保存精确缩放比例
- 这样能在数据重载后保持视线焦点一致，同时避免复杂的缩放还原逻辑
- 对用户体验的结果：
  - 视图中心稳定
  - 视窗宽度可能回到默认宽度，但不会跳到完全不相关的位置
